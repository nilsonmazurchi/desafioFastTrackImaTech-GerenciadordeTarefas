<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Home</title>
    <link rel="stylesheet" href="./assets/css/home.css">
</head>

<body>
    <div id="navbar">
        <div id="mensagemUsuario"></div>
        <!-- <button onclick="apagarTodosUsuarios()">Apagar Todos os Usuários</button> -->
        <button onclick="sair()">Sair</button>
    </div>

    <div id="formularioTarefa">
        <h2>Cadastro de Tarefa</h2>
        <form id="formTarefa">
            <label for="titulo">Título da Tarefa:</label>
            <input type="text" id="titulo" name="titulo" required>

            <label for="dataInicio">Data de Início:</label>
            <input type="date" id="dataInicio" name="dataInicio" required>

            <label for="horaInicio">Horário de Início:</label>
            <input type="time" id="horaInicio" name="horaInicio" required>

            <label for="dataTermino">Data de Término:</label>
            <input type="date" id="dataTermino" name="dataTermino" required>

            <label for="horaTermino">Horário de Término:</label>
            <input type="time" id="horaTermino" name="horaTermino" required>

            <label for="descricao">Descrição da Tarefa:</label>
            <textarea id="descricao" name="descricao" required></textarea>

            <button type="button" onclick="cadastrarTarefa()">Cadastrar Tarefa</button>
        </form>
    </div>

    <div id="listaTarefas">
        <h2>Lista de Tarefas</h2>
        <table>
            <thead>
                <tr>
                    <th>Tarefa</th>
                    <th>Início</th>
                    <th>Término</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tarefasTableBody">                
            </tbody>
        </table>
    </div>
    <div id="modalDescricao" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalDescricao()">&times;</span>
            <h2 id="modalTitulo"></h2>
            <hr class="separador">
            <p id="modalDescricaoTexto"></p>
            <hr class="separador">
            <button class="fechar-btn" onclick="fecharModalDescricao()">Fechar</button>
        </div>
    </div>

    <script >
        document.addEventListener("DOMContentLoaded", function () {
   var usuario = JSON.parse(localStorage.getItem('usuario'));
    console.log(usuario)

    if (usuario) {
        exibirMensagemPeriodoDia(usuario);
        carregarTarefas(usuario);
    } else {
        alert("Usuário não encontrado. Redirecionando para a página de login.");
        window.location.href = "index.html";
    }
});

function exibirMensagemPeriodoDia(usuario) {
    var saudacao = "";
    var dataAtual = new Date();
    var hora = dataAtual.getHours();

    if (hora >= 5 && hora < 12) {
        saudacao = "Bom dia";
    } else if (hora >= 12 && hora < 18) {
        saudacao = "Boa tarde";
    } else {
        saudacao = "Boa noite";
    }

    document.getElementById("mensagemUsuario").innerHTML = saudacao + ", " + usuario.nome + "!";
}

function sair() {    
    localStorage.removeItem('usuario');   
    alert("Sessão encerrada. Redirecionando para a página de login.");
    window.location.href = "index.html";
}

function cadastrarTarefa() {
    var usuario = JSON.parse(localStorage.getItem('usuario'));
    
    if (!usuario) {
        console.error("Usuário não encontrado no localStorage. Redirecionando para a página de login.");
        window.location.href = "index.html";
        return;
    }

    var titulo = document.getElementById("titulo").value;
    var dataInicio = document.getElementById("dataInicio").value;
    var horaInicio = document.getElementById("horaInicio").value;
    var dataTermino = document.getElementById("dataTermino").value;
    var horaTermino = document.getElementById("horaTermino").value;
    var descricao = document.getElementById("descricao").value;

    var novaTarefa = {
        id: gerarIdUnico(),
        titulo: titulo,
        dataInicio: dataInicio,
        horaInicio: horaInicio,
        dataTermino: dataTermino,
        horaTermino: horaTermino,
        descricao: descricao,
        status: "Pendente",
        usuarioId: usuario.email
    };

    function gerarIdUnico() {
        return Date.now(); 
    }

    var tarefas = JSON.parse(localStorage.getItem('tarefas')) || [];
    tarefas.push(novaTarefa);
    localStorage.setItem('tarefas', JSON.stringify(tarefas));
    
    document.getElementById("formTarefa").reset();
    
    carregarTarefas(usuario);
}

function carregarTarefas(usuario) {
    var tarefas = JSON.parse(localStorage.getItem('tarefas')) || [];
    
    var tabelaTarefas = document.getElementById("tarefasTableBody");
   
    tabelaTarefas.innerHTML = "";

    tarefas.forEach(function (tarefa, index) {
        if (tarefa.usuarioId === usuario.email) {
            var row = tabelaTarefas.insertRow();
            
            var colunaTarefa = row.insertCell(0);
            colunaTarefa.innerText = tarefa.titulo;
            
            colunaTarefa.addEventListener("click", function () {
                abrirModalDescricao(tarefa.titulo, tarefa.descricao);
            });
            
            var colunaInicio = row.insertCell(1);
            colunaInicio.innerText = `${tarefa.dataInicio} ${tarefa.horaInicio}`;
           
            var colunaTermino = row.insertCell(2);
            colunaTermino.innerText = `${tarefa.dataTermino} ${tarefa.horaTermino}`;
           
            var colunaStatus = row.insertCell(3);
            colunaStatus.innerText = verificarStatus(tarefa);
           
            var colunaAcoes = row.insertCell(4);
            var botaoAlterar = document.createElement("button");
            botaoAlterar.innerText = "Alterar";
            botaoAlterar.classList.add("botao-alterar");
            botaoAlterar.onclick = function () {
                redirecionarParaPaginaAlterar(tarefa.id); 
            };
           
            colunaAcoes.appendChild(botaoAlterar);           
        }
    });
}

function redirecionarParaPaginaAlterar(tarefaId) {    
    window.location.href = "alterarTarefa.html?tarefaId=" + tarefaId;
}


function verificarStatus(tarefa) {
    var dataAtual = new Date();
    var dataInicio = new Date(tarefa.dataInicio + " " + tarefa.horaInicio);
    var dataTermino = new Date(tarefa.dataTermino + " " + tarefa.horaTermino);

    if (tarefa.status === "Realizada") {
        return "Realizada";
    } else if (dataAtual < dataInicio) {
        return "Pendente";
    } else if (dataAtual >= dataInicio && dataAtual <= dataTermino) {
        return "Em andamento";
    } else {
        return "Em Atraso";
    }
}

function apagarTodosUsuarios() {    
    localStorage.removeItem('usuarios');
    localStorage.removeItem('tarefas');
    
    localStorage.removeItem('usuario');
    localStorage.removeItem('tarefa');
    
    alert("Todos os usuários foram removidos.");
}


function abrirModalDescricao(titulo, descricao) {
    var modal = document.getElementById("modalDescricao");
    var modalTitulo = document.getElementById("modalTitulo");
    var modalDescricaoTexto = document.getElementById("modalDescricaoTexto");

    modal.classList.add("mostrar-modal");

    modal.style.display = "block";
    modalTitulo.innerText = titulo;
    modalDescricaoTexto.innerText = descricao;

    var closeButton = document.createElement("span");
    closeButton.className = "close";
    closeButton.innerHTML = "&times;";
    closeButton.onclick = fecharModalDescricao;

    modalTitulo.appendChild(closeButton);
}

function fecharModalDescricao() {
    var modal = document.getElementById("modalDescricao");    
    modal.classList.remove("mostrar-modal");
    modal.style.display = "none";
}

    </script>
</body>

</html>
